<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Train Search Results</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Modern Fonts: Space Grotesk + Manrope -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#10a37f;
      --accent-2:#2bd39b;
      --accent-warm:#ffb700;
      --heading-bg:linear-gradient(90deg,#10a37f 16%,#0b6b7a 100%);
      --card-bg:rgba(255,255,255,0.72);
      --shadow:0 8px 28px rgba(2,11,44,0.12);
      --radius:14px;
      --border:1px solid rgba(16,163,127,0.07);
      --dark:#061313;
      --muted:#3f5451;
      --error:#c23d4b;
      --font-heading:'Space Grotesk', Arial, sans-serif;
      --font-body:'Manrope', Arial, sans-serif;
    }
    html,body{
      min-height:100%;margin:0;padding:0;background:transparent;
      font-family:var(--font-body);color:var(--dark);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .bg-images{
      position:fixed;inset:0;z-index:-3;
      background:url('/static/images/train7.jpg') center/cover no-repeat;
      filter:saturate(0.94) contrast(0.98);
      pointer-events:none;
    }
    .bg-overlay{
      position:fixed;inset:0;z-index:-2;
      background:rgba(0,0,0,0.33);backdrop-filter:blur(6px);
      pointer-events:none;
    }
    .wrap{
      min-height:100vh;width:100vw;display:flex;
      align-items: flex-start; /* stick to top */
      justify-content: flex-start; /* stick to left */
      padding:48px 0;
    }
    @media(max-width:1100px){ .wrap{padding:32px 0;} }
    @media(max-width:980px){ .wrap{justify-content: center; } }
    .card{
      background:var(--card-bg);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:38px 28px 26px 28px;
      max-width:980px;width:100%;margin-left:60px;position:relative;z-index:2;
      border:var(--border);overflow:hidden;
      animation:slideUp .55s cubic-bezier(.19,.98,.33,1.08);
      display: flex; flex-direction: column;
    }
    @keyframes slideUp{from{opacity:0;transform:translateY(34px);}to{opacity:1;transform:translateY(0);}}
    @media(max-width:1140px){.card{margin-left:22px;} }
    @media(max-width:980px){.card{margin-left:0;} }
    @media(max-width:820px){.card{max-width:99vw;padding:16px 3px;} .wrap{padding:8px 0;} .heading{font-size:1.18rem;} }
    .watermark{
      position:absolute;right:20px;top:14px;width:130px;height:130px;opacity:1;
      background:url('/static/images/irctc_logo.png') center/contain no-repeat;
      pointer-events:none;filter:none;
    }
    .heading{
      font-family:var(--font-heading);font-size:2.2rem;
      font-weight:700;letter-spacing:-0.015em;line-height:1.01;
      background:var(--heading-bg);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
      padding-bottom:6px;margin-bottom:7px;display:inline-block;
      border-bottom:3px solid rgba(16,163,127,0.10);
    }
    .sub{
      font-family:var(--font-body);font-size:1.08rem;font-weight:600;color:var(--muted);
      margin:6px 0 20px 0;letter-spacing:0.01em;max-width:720px;
    }
    .train-info{margin-bottom:18px;}
    #train-list{margin-top:18px;}
    .train{
      background:rgba(255,255,255,0.98);border:1.2px solid rgba(11,94,87,0.10);
      padding:14px 19px;margin-bottom:18px;border-radius:11px;
      box-shadow:0 2px 6px rgba(2,11,44,0.07);
      animation:slideUp .3s cubic-bezier(.15,.91,.36,1.1);
    }
    .train h3{
      font-family:var(--font-heading);font-weight:600;font-size:1.17rem;
      margin:0 0 6px 0;color:var(--dark);
    }
    .chance-low{color:#e42941;font-weight:700;}
    .chance-medium{color:var(--accent-warm);font-weight:700;}
    .chance-high{color:#088b3c;font-weight:700;}
    .btn{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#fff;border:none;padding:10px 26px;border-radius:9px;
      font-family:var(--font-body);font-weight:700;font-size:15px;
      letter-spacing:0.01em;cursor:pointer;box-shadow:0 8px 26px rgba(16,163,127,0.13);
      transition:transform .12s,box-shadow .12s;
      margin-top:9px;
    }
    .btn:hover{transform:translateY(-2px) scale(1.04);box-shadow:0 14px 36px rgba(16,163,127,0.16);}
    #back-button{
      margin-top:24px;padding:12px 30px;background:linear-gradient(90deg,#1a3142 42%,#14342a 100%);
      color:#fff;border:none;border-radius:8px;cursor:pointer;
      font-size:16px;font-family:var(--font-heading);font-weight:600;
      letter-spacing:0.02em;transition:background .2s;
    }
    #back-button:hover{background:linear-gradient(90deg,#215a8d 40%,#215a53 100%);}
    .error-message{color:var(--error);font-weight:bold;margin-top:20px;}
    .train-info p{margin:0 0 6px 0;}
    .loader {
      border: 6px solid #f3f3f3; border-top: 6px solid var(--accent);
      border-radius: 50%; width: 38px; height: 38px;
      animation: spin 1s linear infinite; margin: auto;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% {transform: rotate(360deg);}
    }
    /* Modal Animation Fix */
    .modal {
      position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background: rgba(0,0,0,0.62); transition: opacity .32s;
    }
    .modal:not(.active):not(.closing) { display: none; }
    .modal.active,
    .modal.closing  { display: block; }
    .modal.active {
      opacity: 1;
      animation: modalIn .46s cubic-bezier(.3,.89,.4,1.15) forwards;
    }
    .modal.closing {
      animation: modalOut .55s cubic-bezier(.31,.74,.54,1.09) forwards; /* increased duration */
    }
    @keyframes modalIn {
      0% { opacity: 0; }
      30% { opacity: .3; }
      100% { opacity: 1; }
    }
    @keyframes modalOut {
      0% { opacity:1; }
      100% {opacity:0;transform: scale(.83) translateY(40px);}
    }
    .modal-content {
      background:#fff;margin:7% auto;padding:26px 32px 16px 32px;
      border-radius:14px;
      width:96%;               /* Increased from 88% */
      max-width:720px;         /* Increased from 640px */
      box-shadow:0 7px 34px rgba(0,0,0,0.18);position:relative;text-align:center;
      opacity: 0; transform: scale(0.76) translateY(64px);
      animation: none; transition: opacity .23s, transform .33s;
    }
    .modal.active .modal-content {
      opacity: 1; transform: scale(1) translateY(0);
      animation: modalContentIn .55s cubic-bezier(.26,.91,.45,1.12) forwards;
    }
    .modal.closing .modal-content {
      opacity: 0; transform: scale(0.83) translateY(40px);
      animation: modalContentOut .55s cubic-bezier(.28,.62,.54,1.07) forwards; /* increased duration */
    }
    @keyframes modalContentIn {
      0% {opacity: 0;transform: scale(.76) translateY(64px);}
      65% {opacity:.7;transform: scale(1.07) translateY(-4px);}
      100% {opacity:1;transform: scale(1) translateY(0);}
    }
    @keyframes modalContentOut {
      0% {opacity:1;transform: scale(1) translateY(0);}
      70% {opacity:.5;transform: scale(.97) translateY(22px);}
      100% {opacity:0;transform: scale(.83) translateY(40px);}
    }
    .heatmap-loader {
      display: none;
      width:100%;margin:18px 0 0 0;text-align:center;
      opacity:0;transition:opacity .17s;
    }
    .heatmap-loader.active { display:block; opacity:1; }
    .close {
      position:absolute;right:16px;top:12px;font-size:28px;font-weight:bold;cursor:pointer;color:#474747;
      transition: color .13s;
    }
    .close:hover {color: #10a37f;}
    .heatmap-container img {
      max-width:99%;          /* Slightly increased */
      min-height:340px;       /* Slightly increases height */
      height:auto;
      border-radius:6px;margin-top:10px;box-shadow:0 2px 10px rgba(0,0,0,0.15);
      opacity:0;transition:opacity .18s;
    }
    .heatmap-container img.show {
      opacity:1;
      transition:opacity .34s cubic-bezier(.21,.81,.41,.97);
    }
    @media(max-width:700px){
      .modal-content{padding:13px 5px;}
      .heading{font-size:1.09rem;}
    }
  </style>
</head>
<body>
  <div class="bg-images" aria-hidden="true"></div>
  <div class="bg-overlay"></div>
  <div class="wrap">
    <section class="card">
      <div class="watermark" aria-hidden="true"></div>
      <header>
        <h1 class="heading">Search Results — IRCTC Predictive Dashboard</h1>
        <p class="sub">Discover on-time trains, booking likelihood & live travel intelligence.</p>
      </header>
      <div class="train-info">
        {% if source and destination and journey_date and travel_class %}
          <p>
            Showing trains from <strong>{{ source }}</strong> to <strong>{{ destination }}</strong>
            on <strong>{{ journey_date }}</strong> (Class: <strong>{{ travel_class }}</strong>)
          </p>
        {% else %}
          <p><strong>Missing input data.</strong></p>
        {% endif %}
      </div>
      <div id="spinner" style="text-align:center;margin-bottom:18px;">
        <div class="loader"></div>
        <p>Loading trains...</p>
      </div>
      <div id="train-list"></div>
      <button id="back-button" type="button">← Back to Search</button>
    </section>
  </div>
  <div id="heatmapModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 style="font-family:var(--font-heading);font-size:1.18rem;color:var(--accent);margin-bottom:10px;">Demand Heatmap</h3>
      <div class="heatmap-container">
        <div class="heatmap-loader" id="heatmapLoader">
          <span class="loader"></span>
          <br>
          <span style="font-family:var(--font-body);font-size:1.05em;color:var(--muted);opacity:.92;">Fetching graph...</span>
        </div>
        <img id="heatmapImage" alt="Demand Heatmap" />
        <p id="errorMsg" class="error-message" style="display:none;"></p>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const spinner = document.getElementById("spinner");
      const trainList = document.getElementById("train-list");
      const modal = document.getElementById("heatmapModal");
      const closeModal = document.querySelector(".close");
      const heatmapImage = document.getElementById("heatmapImage");
      const errorMsg = document.getElementById("errorMsg");
      const backButton = document.getElementById("back-button");
      const heatmapLoader = document.getElementById("heatmapLoader");
      let isClosing = false;
      spinner.style.display = "block";
      const trains = {{ trains | tojson }};
      const source = "{{ source }}";
      const destination = "{{ destination }}";
      const journey_date = "{{ journey_date }}";
      const selected_class = "{{ travel_class }}";
      if (!source || !destination || !journey_date || !selected_class) {
        spinner.style.display = "none";
        trainList.innerHTML = "<p><strong>Missing input data.</strong></p>";
        return;
      }
      spinner.style.display = "none";
      if (trains && trains.length > 0) {
        trainList.innerHTML = "";
        trains.forEach(train => {
          let chanceClass = "chance-low";
          const chance = train.confirmation_chance;
          if (chance >= 75) chanceClass = "chance-high";
          else if (chance >= 50) chanceClass = "chance-medium";
          const trainDiv = document.createElement("div");
          trainDiv.className = "train";
          trainDiv.innerHTML = `
            <h3>${train.train_name} (${train.train_no})</h3>
            <p><strong>Confirmation Chance:</strong> <span class="${chanceClass}">${chance}%</span></p>
            <p><strong>Punctuality Rate:</strong> ${train.punctuality_rate}%</p>
            <button class="btn heatmap-btn" data-train="${train.train_no}">📊 View Demand Heatmap</button>
          `;
          trainList.appendChild(trainDiv);
        });
        document.querySelectorAll(".heatmap-btn").forEach(button => {
          button.addEventListener("click", function () {
            const trainNo = this.getAttribute("data-train");
            errorMsg.style.display = "none";
            heatmapImage.style.display = "none";
            heatmapImage.classList.remove("show");
            heatmapLoader.classList.remove("active");
            heatmapLoader.classList.add("active");
            if(isClosing){return;}
            modal.classList.remove("closing");
            modal.classList.add("active");
            setTimeout(function(){ heatmapLoader.classList.add("active"); }, 90);
            fetch(`/demand_heatmap?train_no=${trainNo}`)
              .then(response => response.json())
              .then(data => {
                heatmapLoader.classList.remove("active");
                if (data.success) {
                  heatmapImage.src = `data:image/png;base64,${data.img_data}`;
                  heatmapImage.style.display = "block";
                  setTimeout(function(){ heatmapImage.classList.add("show"); }, 70);
                } else {
                  errorMsg.textContent = data.error || "Failed to load heatmap.";
                  errorMsg.style.display = "block";
                  heatmapImage.style.display = "none";
                }
              })
              .catch(() => {
                heatmapLoader.classList.remove("active");
                errorMsg.textContent = "Error fetching heatmap.";
                errorMsg.style.display = "block";
                heatmapImage.style.display = "none";
              });
          });
        });
      } else {
        trainList.innerHTML = `
          <div class="train" style="text-align:center;">
            <h3>No trains found for this route.</h3>
            <p>There are currently no trains scheduled from <strong>${source}</strong> to <strong>${destination}</strong>
             on <strong>${journey_date}</strong> (Class: <strong>${selected_class}</strong>).</p>
          </div>
        `;
      }
      function closeWithAnimation(){
        if(!modal.classList.contains("active")) return;
        modal.classList.remove("active");
        modal.classList.add("closing");
        isClosing = true;
        heatmapImage.classList.remove("show");
        heatmapLoader.classList.remove("active");
        setTimeout(function(){
          modal.classList.remove("closing");
          heatmapImage.src = "";
          heatmapImage.style.display = "none";
          errorMsg.style.display = "none";
          isClosing = false;
        }, 550); // << increased delay here
      }
      closeModal.addEventListener("click", function () {
        closeWithAnimation();
      });
      window.addEventListener("click", function (event) {
        if (event.target === modal) {
          closeWithAnimation();
        }
      });
      backButton.addEventListener("click", function () {
        window.history.back();
      });
    });
  </script>
</body>
</html>